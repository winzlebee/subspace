version: '3.8'

services:
  subspace:
    image: ghcr.io/winzlebee/subspace/server:latest
    container_name: subspace
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      # Mount the named volume to the correct path where the app stores data
      - subspace_data:/app/data
      # Also mount uploads directory to persist uploaded files
      - subspace_uploads:/app/uploads
    env_file:
      - stack.env
    environment:
      - TURN_PASSWORD=${TURN_PASSWORD:-password}
      # Ensure the database path matches the volume mount
      - DATABASE_URL=/app/data/subspace.db
      - UPLOAD_DIR=/app/uploads
      - BIND_ADDR=0.0.0.0:3001

  coturn:
    image: coturn/coturn
    container_name: subspace-turn
    restart: always
    network_mode: "host"
    env_file:
      - stack.env
    environment:
      - TURN_PASSWORD=${TURN_PASSWORD:-password}
    command:
      - -n
      - --log-file=stdout
      - --min-port=49160
      - --max-port=49200
      - --realm=subspace
      - --user=subspace:${TURN_PASSWORD:-password}
      - --lt-cred-mech
      - --fingerprint
      - --no-cli
    volumes:
      - turn_data:/var/lib/coturn

volumes:
  subspace_data:
    driver: local
  subspace_uploads:
    driver: local
  turn_data:
    driver: local
